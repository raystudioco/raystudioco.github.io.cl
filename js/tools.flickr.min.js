/**
 * Galleria Flickr Plugin 2012-04-04
 * http://galleria.io
 *
 * Licensed under the MIT license
 * https://raw.github.com/aino/galleria/master/LICENSE
 * 
 * modified by RayStudio (2013/12/21)
 * Adding extended Tags function, and flickr collection function.
 */
(function(e){Tools=function(){};Tools.Flickr=function(e){this.api_key=e||"2a2ce06c15780ebeb0b706650fc890b2";this.options={max:30,imageSize:"medium",thumbSize:"thumb",sort:"date-posted-desc",description:true,complete:function(){},backlink:true};this.searchParams={}};Tools.Flickr.prototype={constructor:Tools.Flickr,addText:function(e){if(this.searchParams.text!=null){this.searchParams.text+="+"+e}else{this.searchParams.text=e}return this},addTags:function(e){if(this.searchParams.tags!=null){this.searchParams.tags+="+"+e}else{this.searchParams.tags=e}return this},addSearchOption:function(e,t){this.searchParams[e]=t;return this},setSearchUserId:function(e){this.searchParams.user_id=e;return this},applySearch:function(e){return this._find(this.searchParams,e)},search:function(e,t){return this._find({text:e},t)},tags:function(e,t){return this._find({tags:e},t)},user:function(e,t){return this._call({method:"flickr.urls.lookupUser",url:"flickr.com/photos/"+e},function(e){this._find({user_id:e.user.id,method:"flickr.people.getPublicPhotos"},t)})},set:function(e,t,n){return this._find({photoset_id:e,method:"flickr.photosets.getPhotos"},t,n)},gallery:function(e,t){return this._find({gallery_id:e,method:"flickr.galleries.getPhotos"},t)},groupsearch:function(e,t){return this._call({text:e,method:"flickr.groups.search"},function(e){this.group(e.groups.group[0].nsid,t)})},group:function(e,t){return this._find({group_id:e,method:"flickr.groups.pools.getPhotos"},t)},collection:function(t,n,r){return this._call({user_id:t,collection_id:n,method:"flickr.collections.getTree"},function(t){var n=t.collections.collection[0].set;var i={stat:"inprogress",count:0,length:n.length,data:[]};for(var s=0;s<n.length;s++){this.set(n[s].id,function(t,n){e.extend(t,n);i.data[t.seq]=t;i.count++;if(i.count==i.length){i.stat="complete";r.call(this,i)}},{title:n[s].title,description:n[s].description,seq:s})}})},setOptions:function(t){e.extend(this.options,t);return this},_call:function(t,n){var r="https://api.flickr.com/services/rest/?";var i=this;t=e.extend({format:"json",jsoncallback:"?",api_key:this.api_key},t);e.each(t,function(e,t){r+="&"+e+"="+t});console.log("json url:"+r);e.getJSON(r,function(e){if(e.stat==="ok"){n.call(i,e)}else{Galleria.raise(e.code.toString()+" "+e.stat+": "+e.message,true)}});return i},_getBig:function(e){if(e.url_l){return e.url_l}else if(parseInt(e.width_o,10)>1280){return"http://farm"+e.farm+".static.flickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_b.jpg"}return e.url_o||e.url_z||e.url_m},_getSize:function(e,t){var n;switch(t){case"square":n=e.url_m.replace(/.jpg/g,"_q_d.jpg");break;case"thumb":n=e.url_t;break;case"small":n=e.url_s;break;case"medium":n=e.url_z||e.url_m;break;case"big":n=this._getBig(e);break;case"original":n=e.url_o?e.url_o:this._getBig(e);break;default:n=e.url_z||e.url_m;break}return n},_getWidth:function(e,t){var n;switch(t){case"square":n=75;break;case"thumb":n=e.width_t;break;case"small":n=e.width_s;break;case"medium":n=e.width_z||e.width_z;break;case"big":n=e.width_l;break;case"original":n=e.width_o?e.width_o:width_l;break;default:n=e.width_z||e.width_z;break}return n},_getHeight:function(e,t){var n;switch(t){case"square":n=75;break;case"thumb":n=e.height_t;break;case"small":n=e.height_s;break;case"medium":n=e.height_z||e.height_z;break;case"big":n=e.height_l;break;case"original":n=e.height_o?e.height_o:height_l;break;default:iwidth=e.height_z||e.height_z;break}return n},_find:function(t,n,r){t=e.extend({method:"flickr.photos.search",extras:"url_t,url_m,url_o,url_s,url_l,url_z,description",sort:this.options.sort},t);return this._call(t,function(e){var t=[],i=e.photoset?true:false,s=e.photos?e.photos.photo:e.photoset.photo,o=Math.min(this.options.max,s.length),u,a,f;for(f=0;f<o;f++){u=s[f];t.push({thumb:this._getSize(u,this.options.thumbSize),image:this._getSize(u,this.options.imageSize),width:this._getWidth(u,this.options.imageSize),height:this._getHeight(u,this.options.imageSize),big:this._getBig(u),title:s[f].title,description:this.options.description&&s[f].description?s[f].description._content:"",link:this.options.backlink?"http://flickr.com/photos/"+u.owner+"/"+u.id:""});if(i){if(u.isprimary=="1"){a=u}}}if(i){var l={primary:a,gallery:t};n.call(this,l,r)}else{n.call(this,t,r)}})}}})(jQuery)